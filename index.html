<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceControl Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #4f46e5; --success: #10b981; --danger: #ef4444; 
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --border: #e2e8f0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; min-height: 100vh; }

        /* Sidebar */
        .nav { width: 260px; background: #0f172a; color: white; position: fixed; height: 100vh; padding: 2rem 1rem; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px; color: #94a3b8; text-decoration: none; border-radius: 10px; cursor: pointer; margin-bottom: 5px; transition: 0.3s; }
        .nav-item.active { background: var(--primary); color: white; }
        
        /* Content */
        .content { margin-left: 260px; padding: 2rem; width: 100%; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .card { background: var(--card); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .val { font-size: 1.8rem; font-weight: 700; margin-top: 8px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th { text-align: left; padding: 12px; color: #64748b; font-size: 0.8rem; border-bottom: 2px solid var(--bg); }
        td { padding: 14px 12px; border-bottom: 1px solid var(--bg); font-size: 0.9rem; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
        .bg-p { background: #fee2e2; color: #b91c1c; }
        
        button { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        
        @media (max-width: 768px) {
            .nav { width: 100%; height: 70px; bottom: 0; display: flex; padding: 0; }
            .content { margin-left: 0; padding-bottom: 100px; }
            .nav-item { flex: 1; flex-direction: column; font-size: 0.7rem; justify-content: center; border-radius: 0; }
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-item active" onclick="Route('dash', this)"><span class="material-icons-outlined">dashboard</span><span>Resumo</span></div>
        <div class="nav-item" onclick="Route('pay', this)"><span class="material-icons-outlined">payments</span><span>Pagar</span></div>
        <div class="nav-item" onclick="Route('hist', this)"><span class="material-icons-outlined">history</span><span>Histórico</span></div>
    </nav>

    <main class="content">
        <section id="dash" class="page">
            <h1>Dashboard</h1>
            <div class="grid">
                <div class="card"><small>TOTAL BRUTO</small><div class="val" id="bruto">R$ 0,00</div></div>
                <div class="card"><small style="color:var(--success)">EFETIVADO</small><div class="val" id="pago" style="color:var(--success)">R$ 0,00</div></div>
                <div class="card"><small style="color:var(--danger)">PENDENTE</small><div class="val" id="pend" style="color:var(--danger)">R$ 0,00</div></div>
            </div>
            <div class="card" style="max-width: 500px; margin: auto;"><canvas id="chart" height="300"></canvas></div>
        </section>

        <section id="pay" class="page" style="display:none">
            <div class="card">
                <h2>Contas em Aberto</h2>
                <table>
                    <thead><tr><th>ITEM</th><th>TOTAL</th><th>RESTANTE</th><th>AÇÃO</th></tr></thead>
                    <tbody id="lista-pagar"></tbody>
                </table>
            </div>
        </section>

        <section id="hist" class="page" style="display:none">
            <div class="card">
                <h2>Extrato de Pagamentos</h2>
                <table>
                    <thead><tr><th>DATA</th><th>ITEM</th><th>VALOR</th></tr></thead>
                    <tbody id="lista-historico"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const API = "COLOQUE_AQUI_A_URL_DA_SUA_IMPLANTAÇÃO";

        const App = {
            data: { despesas: [], pagamentos: [] },
            chart: null,

            async init() {
                try {
                    const res = await fetch(API);
                    const json = await res.json();
                    this.data.despesas = json.despesas;
                    this.data.pagamentos = json.pagamentos;
                    this.render();
                } catch (e) { alert("Erro ao carregar dados. Verifique a URL da API."); }
            },

            render() {
                const tBruto = this.data.despesas.reduce((acc, d) => acc + (Number(d.valor_total) || 0), 0);
                const tPago = this.data.pagamentos.reduce((acc, p) => acc + (Number(p.valor_pago) || 0), 0);
                
                document.getElementById("bruto").innerText = this.fmt(tBruto);
                document.getElementById("pago").innerText = this.fmt(tPago);
                document.getElementById("pend").innerText = this.fmt(tBruto - tPago);

                this.renderTabelas();
                this.renderChart(tPago, tBruto - tPago);
            },

            renderTabelas() {
                const pList = document.getElementById("lista-pagar");
                const hList = document.getElementById("lista-historico");
                pList.innerHTML = ""; hList.innerHTML = "";

                this.data.despesas.forEach(d => {
                    const id = (d.id || "").toString();
                    const pagoD = this.data.pagamentos
                        .filter(p => (p.id_despesa || p.id_custos || "").toString() === id)
                        .reduce((acc, p) => acc + (Number(p.valor_pago) || 0), 0);
                    
                    const restante = Number(d.valor_total) - pagoD;
                    if (restante > 0) {
                        pList.innerHTML += `<tr>
                            <td><strong>${d.descricao}</strong></td>
                            <td>${this.fmt(d.valor_total)}</td>
                            <td><span class="badge bg-p">${this.fmt(restante)}</span></td>
                            <td><button onclick="App.pay('${id}')">PAGAR</button></td>
                        </tr>`;
                    }
                });

                [...this.data.pagamentos].reverse().forEach(p => {
                    const idV = (p.id_despesa || p.id_custos || "").toString();
                    const item = this.data.despesas.find(d => (d.id || "").toString() === idV);
                    hList.innerHTML += `<tr>
                        <td>${new Date(p.data_pagamento || p.data).toLocaleDateString()}</td>
                        <td>${item ? item.descricao : 'Item #'+idV}</td>
                        <td style="color:var(--success); font-weight:700">${this.fmt(p.valor_pago)}</td>
                    </tr>`;
                });
            },

            async pay(id) {
                const v = prompt("Valor do pagamento:");
                if(!v) return;
                await fetch(API, { method: "POST", mode: "no-cors", body: JSON.stringify({ tipo: "pagamento", id_despesa: id, valor: v.replace(',','.') }) });
                alert("Enviado! Aguarde 2 segundos para atualizar.");
                setTimeout(() => this.init(), 2000);
            },

            renderChart(pago, pend) {
                const ctx = document.getElementById("chart").getContext("2d");
                if(this.chart) this.chart.destroy();
                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: ['Pago', 'Pendente'], datasets: [{ data: [pago, pend], backgroundColor: ['#10b981', '#ef4444'], borderWidth: 0 }] },
                    options: { cutout: '80%', plugins: { legend: { position: 'bottom' } } }
                });
            },

            fmt(v) { return Number(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        };

        function Route(id, el) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        window.onload = () => App.init();
    </script>
</body>
</html>